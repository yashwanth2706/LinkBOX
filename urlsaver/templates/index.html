{% load static %}
<!DOCTYPE html>
<html lang="en">
	<head>
		<meta charset="UTF-8" />
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />
		<title>LinkBOX</title>
        <!-- Bootstrap -->
		<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/css/bootstrap.min.css" rel="stylesheet"/>
		<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.7/dist/js/bootstrap.bundle.min.js"></script>
        <!-- Driverjs -->
        <script src="https://cdn.jsdelivr.net/npm/driver.js@latest/dist/driver.js.iife.js"></script>
        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/driver.js@latest/dist/driver.css"/>

        <!-- This div is important to check if bootstrap from CDN loaded or not -->
		<div id="css-check" class="d-none"></div>

        <!-- CSS links from static -->
        <link rel="stylesheet" type="text/css" href="{% static 'css/base_sitewide.css' %}">
		<link rel="stylesheet" type="text/css" href="{% static 'css/popup_slidecard.css' %}">

        <!-- JS links from static -->
		<script type="text/javascript" src="{% static 'js/popup_slidecard.js' %}"></script>
        <script type="text/javascript" src="{% static 'js/check_serverstatus.js' %}"></script>

    <script>
        async function checkInternetAccess() {
            try {
                await fetch("https://www.google.com/favicon.ico", { mode: "no-cors" });
                console.log("Internet access confirmed.");
                return true;
            } catch (error) {
                console.log("No internet access:", error);
                return false;
            }
        }

        (async () => {
            const internetStatus = await checkInternetAccess();
            if (!internetStatus) {

                // Load local bootstrap
                const bootStrapLink = document.createElement("link");
                bootStrapLink.rel = "stylesheet";
                bootStrapLink.href = "{% static 'bootstrap-5.3.7-dist/css/bootstrap.min.css' %}";
                document.head.appendChild(bootStrapLink);

                const bootStrapScript = document.createElement("script");
                bootStrapScript.src = "{% static 'bootstrap-5.3.7-dist/js/bootstrap.bundle.min.js' %}";
                document.body.appendChild(bootStrapScript);

                // Load local driverjs
                const driverLink = document.createElement("link");
                driverLink.rel = "stylesheet";
                driverLink.href = "{% static 'driver.js/dist/driver.css' %}";
                document.head.appendChild(driverLink);

                const driverScript = document.createElement("script");
                driverScript.src = "{% static 'driver.js/dist/driver.js.iife.js' %}";
                document.body.appendChild(driverScript);

                console.log("Internet unavailable -> loaded local bootstrap and driverjs resources");
            }
        })();
    </script>
	</head>
	<body>

		<!-- <nav>bar START
        style and script for popup are defined in 
        static/css/popup_slidecard.css
        static/css/popup_slidecard.css
        -->
    <nav class="navbar navbar-light bg-light">
        <div class="container d-flex align-items-center">
            <!-- Left: App Name -->
            <h3 class="m-0"><strong style="color:white">LinkBOX</strong></h3>

            <!-- Center: Username -->
            {% if user.is_authenticated %}
            <h4>
            <span class="mx-auto" style="color:white">Welcome, {{ user.username }}</span>
            </h4>
            {% endif %}

            <!-- Right: Logout -->
            {% if user.is_authenticated %}
            <form action="{% url 'urlsaver:logout' %}" method="post" class="m-0">
                {% csrf_token %}
                <button type="submit" class="btn btn-light btn-sm">Logout</button>
            </form>
            {% endif %}
        </div>
    </nav>
		<!-- <nav>bar END -->
    
    <!-- Popup section start -->
    <section>
        <div id="popup-container" style="font-family: 'Calibri';"></div>
    </section>
    <!-- Popup section end -->
<!-- Modal Popup for Preview START -->
     <style>
        /* Custom styling for the preview card image */
        .preview-card-img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            background-color: #e9ecef;
        }
        
        /* Custom styling for the description to limit lines */
        .preview-description {
            display: -webkit-box;
            -webkit-box-orient: vertical;
            -webkit-line-clamp: 3; /* For Safari and older browsers */
            line-clamp: 3; /* Standard property */
            overflow: hidden;
            height: 60px; /* Fallback height */
        }
    </style>
 <!-- Bootstrap Modal for Preview -->
<div class="modal fade" id="previewModal" tabindex="-1" aria-labelledby="previewModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header border-0">
                <h5 class="modal-title" id="previewModalLabel">Link Preview</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0">
                <div class="card border-0">
                    <img id="previewImage" class="card-img-top preview-card-img" alt="Link Preview Image" crossorigin="anonymous" onerror="this.style.display='none'; if(typeof showPopup === 'function') { showPopup('Image cannot be show in preview', 'orange', true, 3000, 'preview-partial'); }">
                    <!--<img id="previewImage" src="" ... onerror="if(this.src) { this.style.display='none'; if(typeof showPopup === 'function') { showPopup('Image cannot be show in preview', 'orange', true, 3000, 'preview-partial'); } }">-->
                    <!--<img id="previewImage" src="" class="card-img-top preview-card-img" alt="Link Preview Image" crossorigin="anonymous" onerror="this.style.display='none'; if(typeof showPopup === 'function') { showPopup('Image cannot be show in preview', 'orange', true, 3000, 'preview-partial'); }">-->
                    <div class="card-body">
                        <h5 id="previewTitle" class="card-title fw-bold text-truncate"></h5>
                        <p id="previewDescription" class="card-text text-muted small preview-description"></p>
                        <a id="previewUrl" href="#" target="_blank" rel="noopener noreferrer" class="text-primary small text-truncate d-block"></a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- Modal Popup for Preview END -->

		<!-- Action Buttons -->
		<div class="d-flex justify-content-center gap-3 mt-4">
			<button
					class="btn btn-outline-dark btn-sm"
					data-bs-toggle="modal"
					data-bs-target="#addUrlModal"
					>
					+ Add URL
			</button>
            <button
                class="btn btn-outline-dark btn-sm"
                data-bs-toggle="offcanvas"
                data-bs-target="#csvUploadCanvas">
                + Import URLs via CSV
            </button>
			<button
					class="btn btn-outline-dark btn-sm"
					data-bs-toggle="offcanvas"
					data-bs-target="#activityPanel"
					>
					Activity
			</button>
		</div>

		<!-- Activity Offcanvas -->
		<div class="offcanvas offcanvas-end" tabindex="-1" id="activityPanel">
			<div class="offcanvas-header">
				<h5 class="offcanvas-title">Activity</h5>
				<button
						type="button"
						class="btn-close"
						data-bs-dismiss="offcanvas"
						></button>
			</div>
			<div class="offcanvas-body">
				<p>
				<strong>Number of URLs stored:</strong> <span id="total-url-count">{{ total_url_count }}</span>
				</p>
				<hr />
                <p>
				<strong>Number of URLs trashed:</strong> <span id="trashed-url-count">{{ trashed_url_count }}</span>
				</p>
				<hr />
			</div>
		</div>


<!-- URL Input Modal (Used for Add & Edit) -->
		<div class="modal fade" id="addUrlModal" tabindex="-1" aria-labelledby="addUrlModalLabel" aria-hidden="true">
			<div class="modal-dialog modal-dialog-centered">
				<div class="modal-content shadow">
					<div class="modal-header">
						<h5 class="modal-title" id="addUrlModalLabel">Add a New URL</h5> <!-- ← Will change to "Edit URL" dynamically -->
						<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
					</div>

					<!-- We'll dynamically update `action` via JS -->
					<form method="post" id="urlForm" action="{% url 'urlsaver:add_url' %}">
						{% csrf_token %}
						<div class="modal-body">
							<input type="hidden" id="url-id" name="url_id" /> <!-- for editing -->

							<div class="mb-3">
								<label for="url-textarea" class="form-label">*Enter or paste your URL:</label>
								<textarea class="form-control" id="url-textarea" name="url" rows="2" placeholder="https://example.com" required></textarea>
							</div>

							<div class="mb-3">
								<label for="name" class="form-label">Name (optional)</label>
								<input type="text" class="form-control" id="name" name="name" placeholder="e.g. Google">
							</div>

							<div class="row">
								<div class="col-md-6 mb-3">
									<label for="category" class="form-label" required>Category</label>
									<select class="form-select" id="category" name="category">
										<option selected disabled>Choose category</option>
										<option value="youtube">YouTube</option>
										<option value="facebook">Facebook</option>
										<option value="instagram">Instagram</option>
										<option value="website">Website-Link</option>
										<option value="others">Others</option>
									</select>

									<div class="mt-2" id="custom-category-group" style="display: none">
										<label for="custom-category" class="form-label">Custom Category Name</label>
										<input type="text" class="form-control" id="custom-category" name="custom_category" placeholder="e.g. MySpecialLinks">
									</div>
								</div>

								<div class="col-md-6 mb-3">
									<label for="sub-category" class="form-label">Sub Category (optional)</label>
									<input type="text" class="form-control" id="sub-category" name="sub_category" placeholder="e.g. Free Illustrations">
								</div>
							</div>

							<div class="mb-3">
								<label for="tags" class="form-label">Tags (Optional) - Comma Separated</label>
								<input type="text" class="form-control" id="tags" name="tags" placeholder="e.g. design, inspiration, vector">
							</div>
						</div>

						<div class="modal-footer">
							<button type="submit" class="btn btn-primary" id="submit-button">Save URL</button>
						</div>
					</form>
<script>
document.addEventListener("DOMContentLoaded", function () {
    const urlForm = document.getElementById("urlForm");
    const addUrlModal = document.getElementById("addUrlModal");

    // Reset form when modal is closed
    addUrlModal.addEventListener("hidden.bs.modal", function () {
        resetFormToDefault();
    });

    function resetFormToDefault() {
        urlForm.reset();

        // Reset form action back to default add URL endpoint
        urlForm.action = "{% url 'urlsaver:add_url' %}";

        // Reset hidden ID field
        document.getElementById("url-id").value = "";

        // Reset modal title & button text
        document.getElementById('addUrlModalLabel').textContent = 'Add URL';
        document.getElementById('submit-button').textContent = 'Save URL';

        // Hide custom category section
        document.getElementById('custom-category-group').style.display = 'none';
        document.getElementById('custom-category').value = "";
    }
});
</script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    const urlForm = document.getElementById('urlForm');

    urlForm.addEventListener('submit', function(event) {
        // 1. Prevent the default browser form submission (the page reload)
        event.preventDefault();

        const form = event.target;
        const url = form.action; // The URL to send the data to (e.g., /edit-url/9/)
        const formData = new FormData(form);

        // 2. Send the form data in the background using the Fetch API
        fetch(url, {
            method: 'POST',
            body: formData,
            // Add the CSRF token to the request headers
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken')
            }
        })
        .then(response => response.json()) // Parse the JSON response from the server
        .then(data => {
            // 3. Process the JSON data
            if (data.status === 'success') {
                // On success:
                // a. Close the modal
                const modalEl = document.getElementById('addUrlModal');
                const modal = bootstrap.Modal.getInstance(modalEl);
                modal.hide();

                // b. Show your success popup (you already have this function)
                showPopup(data.message, 'green', true, 3000, 'edit-success');
                
                // c. Reload the page to see the changes (simplest way)
                setTimeout(() => {
                    location.reload();
                }, 1000); // Reload after 1 second

            } else if (data.status === 'error') {
                // On error:
                // For now, we'll just show a generic error.
                // You could expand this to show specific field errors from data.errors
                let errorMessage = 'Please fix the errors below.';
                if (data.errors.url) {
                    errorMessage = data.errors.url[0]; // Show the specific URL error
                }
                showPopup(errorMessage, 'red', true, 3000, 'edit-error');
            }
        })
        .catch(error => {
            console.error('Submission failed:', error);
            showPopup('An unexpected error occurred.', 'red', true, 3000, 'edit-unexpected-error');
        });
    });
});
</script>
			</div>
		</div>
	</div>

<!-- Import via CSV START -->

<!-- Offcanvas for CSV Upload -->
<div class="offcanvas offcanvas-end" tabindex="-1" id="csvUploadCanvas" 
     data-bs-scroll="true" style="--bs-offcanvas-width: 600px; overflow-y: hidden;">
  <div class="offcanvas-header">
    <h5 class="offcanvas-title">Import urls via <b>csv</b></h5>
    <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
  </div>
  <div class="offcanvas-body">
    <!-- Upload Form -->
    <form id="csvUploadForm" method="post" enctype="multipart/form-data" action="{% url 'urlsaver:import_csv' %}">
      {% csrf_token %}
      <div class="mb-3">
        <label for="csvFile" class="form-label">Choose a <b>csv</b> file</label>
        <input class="form-control" type="file" name="csv_file" id="csvFile" accept=".csv" required>
      </div>
      <button type="submit" class="btn btn-dark">Upload</button>
    </form>
        
    <!-- CSV Import Help Section -->
    <div class="alert alert-info small mt-3" role="alert">
      <strong>Recommended <b>column name(s)</b> and <b>data format</b> for CSV import to be successful:</strong>
      <pre class="mt-2 mb-0">
name,url,category,sub category,tags 
Profileme,https://www.profileme.dev,website,Profile Builder,"Github,Profile"
      </pre>

      <p class="mt-2 mb-1"><u>OR</u> (If you don't plan to add category, sub category, or tags, leave blank):</p>
      <pre class="mb-0">
name,url,category,sub category,tags 
YouTube,https://www.youtube.com,,,"streaming, media"
StackOverflow,https://stackoverflow.com,,community,
      </pre>

      <p class="mt-2 mb-1"><u>OR</u> (Bulk URLs only, without name/category/tags — names will be auto-generated):</p>
      <pre class="mb-0">
url
https://docs.djangoproject.com/en/5.2/intro/tutorial01/
https://www.pythonguis.com/tutorials/creating-your-first-pyqt-window/#menu
      </pre>

      <p class="mt-2 mb-1"><strong>Minimum requirement:</strong></p>
      <pre class="mb-0">
url
https://www.example.com
      </pre>
    </div>
  </div>
</div>

<!-- Import result modal -->
<div class="modal fade" id="importResultModal" tabindex="-1" role="dialog">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Import Result</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body" id="importResultMessage">
        <!-- Message will be injected here -->
      </div>
    </div>
  </div>
</div>

<script>
document.getElementById("csvUploadForm").addEventListener("submit", function(e) {
    e.preventDefault();  // Stop normal form submission

    let formData = new FormData(this);

    fetch(this.action, {
        method: "POST",
        body: formData,
        headers: { "X-Requested-With": "XMLHttpRequest" }
    })
    .then(response => response.json())
    .then(data => {
        // Insert server response into modal
        document.getElementById("importResultMessage").innerText = data.message;

        // Show modal (Bootstrap 5)
        let modal = new bootstrap.Modal(document.getElementById("importResultModal"));
        modal.show();

        // Relaod page on modal close
        document.getElementById("importResultModal")
            .addEventListener("hidden.bs.modal", function () {
                window.location.reload();
            }, { once: true });

    })
    .catch(error => {
        console.error("Error:", error);
    });
});
</script>

<!-- Import via CSV END -->

<!-- URL Table Card (Updated Features) -->
<div class="container-fluid mt-5">
    <div class="p-3 border shadow-sm bg-white">
            <!-- Everything stacked in one column -->
    <div class="d-flex flex-column gap-3">
        <!-- FIX: Combined Search and Filter into a single form for robustness. -->
        <form method="get" name="myname">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 class="mb-0">Stored URLs</h5>
                <div class="d-flex gap-2 align-items-center">
                    <!-- Search input and button are now part of the main form -->
                    <div class="d-flex align-items-center me-2">
                         <input
                                type="text"
                                name="search"
                                class="form-control form-control-sm"
                                placeholder="Search URLs by Name..."
                                value="{{ search_query }}"
                                style="max-width: 200px"
                        />
                        <button type="submit" class="btn btn-sm btn-primary ms-1">Search</button>
                    </div>

                    <!-- These buttons are not part of the form submission -->
                    <button class="btn btn-outline-secondary btn-sm" type="button" onclick="toggleFilters()">
                        Filters
            <div class="btn-group">
                <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" data-bs-toggle="dropdown">
                    Export
                </button>
                <ul class="dropdown-menu">
                    <li><a class="dropdown-item" href="#" onclick="exportSelected('csv')">Export Selected as CSV</a></li>
                    <li><a class="dropdown-item" href="#" onclick="exportSelected('pdf')">Export Selected as PDF</a></li>
                </ul>
            </div>
    <script>
    function exportSelected(type) {
        const checkboxes = document.querySelectorAll(".row-checkbox:checked");

        // Determine form action URL
        let actionUrl;
        if (checkboxes.length === 0) {
            const confirmExportAll = confirm("No URLs selected. Do you want to export all URLs?");
            if (!confirmExportAll) {
                showPopup("Export canceled", "red", true, 2000, "export-error");
                return;
            }
            showPopup("Exporting all URLs...", "green", true, 2000, "export-success");
            actionUrl = type === "csv" ? "{% url 'urlsaver:export_all_csv' %}" : "{% url 'urlsaver:export_all_pdf' %}";
        } else {
            // Some checkboxes selected
            actionUrl = type === "csv" ? "{% url 'urlsaver:export_selected_csv' %}" : "{% url 'urlsaver:export_selected_pdf' %}";
        }

        // Create a form dynamically
        const form = document.createElement("form");
        form.method = "POST";
        form.action = actionUrl;

        // CSRF token
        const csrf = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const csrfInput = document.createElement("input");
        csrfInput.type = "hidden";
        csrfInput.name = "csrfmiddlewaretoken";
        csrfInput.value = csrf;
        form.appendChild(csrfInput);

        // If exporting selected, add selected IDs
        if (checkboxes.length > 0) {
            checkboxes.forEach(cb => {
                const input = document.createElement("input");
                input.type = "hidden";
                input.name = "selected_urls[]";
                input.value = cb.value;
                form.appendChild(input);
            });
        }

        document.body.appendChild(form);
        form.submit();
        form.remove();
    }
    </script>
                    <button class="btn btn-outline-danger btn-sm" type="button" onclick="showTrashPopup()">
                        Show Trash
                    </button>
                </div>
            </div>

            <!-- Filter section is now just a div within the single form -->
            <div id="filter" class="row g-2 mb-3" style="display: none;">
                <div class="col-md-3">
                    <input type="text" name="tag" class="form-control form-control-sm" placeholder="Filter by Tag" value="{{ tag }}">
                </div>
                <div class="col-md-3">
                    <input type="text" name="category" class="form-control form-control-sm" placeholder="Filter by Category" value="{{ category }}">
                </div>
                <div class="col-md-3">
                    <input type="text" name="sub_category" class="form-control form-control-sm" placeholder="Filter by Sub Category" value="{{ sub_category }}">
                </div>
                <div class="col-md-3 d-flex">
                    <!-- This button will now submit the entire form, including the search query -->
                    <button type="submit" class="btn btn-sm btn-primary w-100">Apply Filters</button>
                </div>
            </div>
        </form>

        <!-- This form for bulk actions remains separate because it uses POST -->
        <form id="bulkDeleteForm" method="post" action="{% url 'urlsaver:delete_selected' %}">
            {% csrf_token %}
            <div class="table-responsive">
                <table class="table table-bordered table-hover">
                    <thead class="table-light">
                    <tr>
                        <th title="Select All"><input id="selectAll" type="checkbox"></th>
                        <th>#</th>
                        <th>Name</th>
                        <th>Category</th>
                        <th>Sub Category</th>
                        <th>Tags</th>
                        <th class="text-center">Preview</th>
                        <th class="text-center">Visit</th>
                        <th class="text-center">Edit</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% if page_obj %}
                    {% for url in page_obj %}
                    <tr>
                        <td><input type="checkbox" class="row-checkbox" name="selected_urls" value="{{ url.id }}"></td>
                        <td>{{ forloop.counter }}</td>
                        <td>{{ url.name }}</td>
                        <td>{{ url.effective_category }}</td>
                        <td>{{ url.sub_category }}</td>
                        <td>{{ url.tags }}</td>
                        <td class="text-center">
                    <button type="button" class="btn btn-sm btn-outline-secondary preview-btn" data-url="{{ url.url|escapejs }}">Preview</button>
                        </td>
                        <td class="text-center">
                            <a target="_blank" rel="noopener noreferrer" href="{% url 'urlsaver:visit_url' url.id %}" class="btn btn-sm btn-primary">Visit</a>
                        </td>
                        <td class="text-center">
                            <button type="button" class="btn btn-outline-dark btn-sm"
                                    onclick="openEditModal('{{ url.id }}', '{{ url.name|escapejs }}', '{{ url.url|escapejs }}', '{{ url.category }}', '{{ url.custom_category|escapejs }}', '{{ url.sub_category|escapejs }}', '{{ url.tags|escapejs }}')">
                                Edit
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                    {% else %}
                    <tr>
                        <td colspan="10" class="text-center">No URLs found.</td>
                    </tr>
                    {% endif %}
                    </tbody>
                </table>
            </div>
        </form>
<script>
    // Wait for the document to be fully loaded before attaching event listeners
    document.addEventListener('DOMContentLoaded', () => {
        
        // Get the Bootstrap Modal instance
        const previewModalEl = document.getElementById('previewModal');
        const previewModal = new bootstrap.Modal(previewModalEl);

        // Get all the preview buttons
        const previewButtons = document.querySelectorAll('.preview-btn');

        // Attach a click event listener to each button
        previewButtons.forEach(button => {
            button.addEventListener('click', function() {
                const url = this.dataset.url; // Get the URL from the data-url attribute
                generatePreview(url, this); // Pass the URL and the button itself to the function
            });
        });

        // --- Core Link Preview Functions ---

        /**
         * Main function to generate the link preview.
         * @param {string} url - The URL to preview.
         * @param {HTMLElement} button - The button that was clicked.
         */
        async function generatePreview(url, button) {
            if (!url) {
                console.error("No URL provided for preview.");
                return;
            }

            const originalButtonContent = button.innerHTML;
            // Show a loading spinner inside the button
            button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
            button.disabled = true;

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 10000); // 10-second timeout

            try {
                const proxyUrl = `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`;
                const response = await fetch(proxyUrl, { signal: controller.signal });
                
                clearTimeout(timeoutId);

                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const data = await response.json();
                const htmlContent = data.contents;
                if (!htmlContent) throw new Error('Could not fetch the content of the URL.');

                const metadata = parseMetadata(htmlContent, url);
                updatePreviewCard(metadata);
                previewModal.show();

            } catch (error) {
                let errorMessage = 'Failed to generate preview.';
                if (error.name === 'AbortError') {
                    errorMessage = 'Request timed out.';
                }
                // Use your existing popup function for errors
                    showPopup(errorMessage, 'red', true, 3000, 'preview-error');
                console.error('Error fetching or parsing URL:', error);
            } finally {
                // Restore the button to its original state
                button.innerHTML = originalButtonContent;
                button.disabled = false;
            }
        }

        /**
         * Updates the DOM elements of the preview card with the extracted metadata.
         */
        function updatePreviewCard(metadata) {
            const previewImage = document.getElementById('previewImage');
            const previewTitle = document.getElementById('previewTitle');
            const previewDescription = document.getElementById('previewDescription');
            const previewUrl = document.getElementById('previewUrl');

            if (metadata.image) {
                previewImage.src = metadata.image;
                previewImage.style.display = 'block';
            } else {
                previewImage.style.display = 'none';
            }

            previewTitle.textContent = metadata.title;
            previewDescription.textContent = metadata.description;
            previewUrl.href = metadata.url;
            previewUrl.textContent = new URL(metadata.url).hostname;
        }

        /**
         * Parses the HTML content to extract metadata.
         */
        function parseMetadata(html, baseUrl) {
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');

            const getMetaTag = (name) => {
                const element = doc.querySelector(`meta[property='og:${name}']`) || doc.querySelector(`meta[name='${name}']`);
                return element ? element.getAttribute('content') : null;
            };

            const title = getMetaTag('title') || doc.querySelector('title')?.textContent || 'No Title Found';
            const description = getMetaTag('description') || 'No Description Found';
            let imageUrl = getMetaTag('image');

            if (imageUrl) {
                try {
                    imageUrl = new URL(imageUrl, baseUrl).href;
                } catch (e) {
                    imageUrl = null;
                }
            }
            return { title, description, image: imageUrl, url: baseUrl };
        }
    });
</script>

        <!-- Pagination -->
        <div class="d-flex justify-content-between align-items-center">
        <!-- Records per page selector -->
        <div class="form-inline">
            <label for="recordsPerPage" class="mr-2">Show</label>
            <select id="recordsPerPage" class="form-control form-control-sm" onchange="updateRecordsPerPage(this)">
                <option value="5" {% if show_n_records == 5 %}selected{% endif %}>5</option>
                <option value="10" {% if show_n_records == 10 %}selected{% endif %}>10</option>
                <option value="15" {% if show_n_records == 15 %}selected{% endif %}>15</option>
                <option value="25" {% if show_n_records == 25 %}selected{% endif %}>25</option>
            </select>
            <span class="ml-2">records</span>
        </div>
            <!-- Left: Remove button -->
            <button type="button" class="btn btn-sm btn-danger" onclick="removeSelected()">
                Remove Selected
            </button>
            <nav aria-label="Page navigation">
                <ul class="pagination pagination-sm justify-content-end">
                    {# Previous button #}
                    {% if page_obj.has_previous %}
                    <li class="page-item">
                        <a class="page-link"
                        href="?page={{ page_obj.previous_page_number }}&search={{ search_query }}&tag={{ tag }}&category={{ category }}&sub_category={{ sub_category }}&show_n_records={{ show_n_records }}">
                            Previous
                        </a>
                    </li>
                    {% else %}
                    <li class="page-item disabled"><span class="page-link">Previous</span></li>
                    {% endif %}

                    {# Show first page #}
                    {% if page_obj.number > 3 %}
                        <li class="page-item">
                            <a class="page-link" href="?page=1&search={{ search_query }}&tag={{ tag }}&category={{ category }}&sub_category={{ sub_category }}&show_n_records={{ show_n_records }}">1</a>
                        </li>
                        {% if page_obj.number > 4 %}
                            <li class="page-item disabled"><span class="page-link">...</span></li>
                        {% endif %}
                    {% endif %}

                    {# Page neighbors #}
                    {% for num in page_obj.paginator.page_range %}
                        {% if num >= page_obj.number|add:-2 and num <= page_obj.number|add:2 %}
                            {% if page_obj.number == num %}
                                <li class="page-item active"><span class="page-link">{{ num }}</span></li>
                            {% else %}
                                <li class="page-item">
                                    <a class="page-link"
                                    href="?page={{ num }}&search={{ search_query }}&tag={{ tag }}&category={{ category }}&sub_category={{ sub_category }}&show_n_records={{ show_n_records }}">
                                    {{ num }}
                                    </a>
                                </li>
                            {% endif %}
                        {% endif %}
                    {% endfor %}

                    {# Show last page #}
                    {% if page_obj.number < page_obj.paginator.num_pages|add:-2 %}
                        {% if page_obj.number < page_obj.paginator.num_pages|add:-3 %}
                            <li class="page-item disabled"><span class="page-link">...</span></li>
                        {% endif %}
                        <li class="page-item">
                            <a class="page-link" href="?page={{ page_obj.paginator.num_pages }}&search={{ search_query }}&tag={{ tag }}&category={{ category }}&sub_category={{ sub_category }}&show_n_records={{ show_n_records }}">
                                {{ page_obj.paginator.num_pages }}
                            </a>
                        </li>
                    {% endif %}

                    {# Next button #}
                    {% if page_obj.has_next %}
                    <li class="page-item">
                        <a class="page-link"
                        href="?page={{ page_obj.next_page_number }}&search={{ search_query }}&tag={{ tag }}&category={{ category }}&sub_category={{ sub_category }}&show_n_records={{ show_n_records }}">
                            Next
                        </a>
                    </li>
                    {% else %}
                    <li class="page-item disabled"><span class="page-link">Next</span></li>
                    {% endif %}
                </ul>
            </nav>
        </div>
    </div>
    </div>
</div>
<script>
function updateRecordsPerPage(select) {
    const value = select.value;
    const url = new URL(window.location.href);
    url.searchParams.set("show_n_records", value);
    url.searchParams.set("page", 1);
    window.location.href = url.toString();
}
</script>

		<!-- Export Popup Modal -->
		<div class="modal fade" id="exportModal" tabindex="-1" aria-hidden="true">
			<div class="modal-dialog">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title">Export Options</h5>
						<button
								type="button"
								class="btn-close"
								data-bs-dismiss="modal"
								></button>
					</div>
					<div class="modal-body">
						<button class="btn btn-outline-primary w-100 mb-2">
							Export as PDF
						</button>
						<button class="btn btn-outline-success w-100">Export as CSV</button>
					</div>
				</div>
			</div>
		</div>

		<!-- Trash Popup Modal -->
		<div class="modal fade" id="trashModal" tabindex="-1" aria-hidden="true">
			<div class="modal-dialog modal-lg">
				<div class="modal-content">
					<div class="modal-header">
						<h5 class="modal-title" style="margin:10px;">Recycle Bin</h5>
						<h6 style="font-size: 12px; color:blue">*Contents are deleted permanently after 30days from the time of removal</h6>
						<button
								type="button"
								class="btn-close"
								data-bs-dismiss="modal"
								></button>
					</div>
					<div class="modal-body">
						<table class="table table-bordered table-hover">
							<thead class="table-light">
								<tr>
									<th><input type="checkbox" id="selectAllTrash"/></th>
									<th>#</th>
									<th>Name</th>
									<th>URL</th>
									<th>Category</th>
									<th>Deleted On</th>
								</tr>
							</thead>
							<tbody  id="trashTableBody">
								<!-- Trash rows here -->

							</tbody>
						</table>
						<nav>
							<ul class="pagination pagination-sm justify-content-end" id="trashPagination"></ul>
						</nav>
						<div class="d-flex justify-content-between">
							<button class="btn btn-outline-success" onclick="recoverSelected()">Retrieve Selected</button>
							<button
									title = "Deletes Everything Permanently from Trash"
									class="btn btn-outline-danger"
									onclick="deleteAll()">
								Empty Trash
							</button>
							<button
									title = "Deletes only selected item(s)"
									class="btn btn-outline-danger"
									onclick="deleteSelected()">
								Delete Selected
							</button>
						</div>
					</div>
				</div>
			</div>
		</div>

		<!-- Script tags for Web Actions -->

<script>
    // This function runs when the page has finished loading
    document.addEventListener('DOMContentLoaded', function() {
        // Fetch data from the new URL
        fetch("{% url 'urlsaver:activity_data' %}")
            .then(response => response.json())
            .then(data => {
                // Update the HTML elements with the data from the view
                document.getElementById('total-url-count').textContent = data.total_url_count;
                document.getElementById('trashed-url-count').textContent = data.trashed_url_count;
            })
            .catch(error => console.error('Error fetching activity data:', error));
    });
</script>        

<script>
document.addEventListener("DOMContentLoaded", function () {
    const urlForm = document.getElementById("urlForm");
    const addUrlModal = document.getElementById("addUrlModal");

    // Reset form when modal is closed
    addUrlModal.addEventListener("hidden.bs.modal", function () {
        resetFormToDefault();
    });

    function resetFormToDefault() {
        urlForm.reset();

        // Reset form action back to default add URL endpoint
        urlForm.action = "{% url 'urlsaver:add_url' %}";

        // Reset hidden ID field
        document.getElementById("url-id").value = "";

        // Reset modal title & button text
        document.getElementById('addUrlModalLabel').textContent = 'Add URL';
        document.getElementById('submit-button').textContent = 'Save URL';

        // Hide custom category section
        document.getElementById('custom-category-group').style.display = 'none';
        document.getElementById('custom-category').value = "";
    }
});
</script>

		<script>
			document.addEventListener('DOMContentLoaded', function () {
				const categorySelect = document.getElementById("category");
				const customCategoryGroup = document.getElementById("custom-category-group");

				categorySelect.addEventListener("change", function () {
					customCategoryGroup.style.display =
						this.value === "others" ? "block" : "none";
				});

				const selectAll = document.getElementById('selectAll');
				selectAll.addEventListener('change', function () {
					const isChecked = this.checked;
					document.querySelectorAll('tbody .row-checkbox').forEach(cb => {
						cb.checked = isChecked;
					});
				});
			}); 

			function showExportPopup() {
				const modal = new bootstrap.Modal(
					document.getElementById("exportModal")
				);
				modal.show();
			}

			function showTrashPopup() {
				const modal = new bootstrap.Modal(
					document.getElementById("trashModal")
				);
				modal.show();
			}


		</script>
		<script>
			function removeSelected() {
				// Used JS submit to check the edge case if no row is checked then alert the user or else 
				// If confirmed submit via javascript, Django handels post from indide the form
				let checkboxes = document.querySelectorAll('.row-checkbox:checked');
				if (checkboxes.length === 0) {
					showPopup("No URL has been selected", 'yellow' ,true, 2000, 'checkbox-status');
					//alert("Please select at least one URL to remove.");
					return;
				}
				if (confirm("Are you sure you want to move the selected URLs to trash?")) {
					document.getElementById('bulkDeleteForm').submit();
				}
			}

			// Select/Deselect All
			document.getElementById('selectAll').addEventListener('change', function() {
				document.querySelectorAll('.row-checkbox').forEach(cb => cb.checked = this.checked);
			});
		</script>

		<!-- Script to toggle filter visibility -->
		<script>
			function toggleFilters() {
				const filterForm = document.getElementById('filter');
				filterForm.style.display = filterForm.style.display === 'none' ? 'flex' : 'none';
			}

		</script>

		<script>

			// 1. Get the modal element and create the Bootstrap modal instance ONCE.
			const trashModalEl = document.getElementById('trashModal');
			const trashModal = new bootstrap.Modal(trashModalEl);

			// 2. This function OPENS the modal and loads the first page of data.
			// Updated function to show trash popup
			function showTrashPopup() {
				// Check if trashModal is available before using it
				if (typeof window.trashModal === 'undefined') {
					console.error('Bootstrap Modal is not initialized yet.');
					return;
				}

				// Fetch data for the first page
				fetch(`/trash_data/?page=1`)
					.then(response => response.json())
					.then(data => {
						// Update the modal's content
						document.getElementById('trashTableBody').innerHTML = data.rows_html;
						document.getElementById('trashPagination').innerHTML = data.pagination_html;

						// Show the modal
						trashModal.show();
					})
					.catch(error => console.error('Error opening trash modal:', error));
			}

			// 3. This function is ONLY for pagination. It just updates content inside the ALREADY OPEN modal.
			function loadTrashPage(page) {
				fetch(`/trash_data/?page=${page}`)
					.then(response => response.json())
					.then(data => {
						// Just update the content.
						document.getElementById('trashTableBody').innerHTML = data.rows_html;
						document.getElementById('trashPagination').innerHTML = data.pagination_html;
					})
					.catch(error => console.error('Error loading trash page:', error));
			}

		</script>
		<script>
			document.addEventListener('change', function (e) {
				if (e.target.id === 'selectAllTrash') {
					const checked = e.target.checked;
					document.querySelectorAll('.trash-checkbox').forEach(cb => {
						cb.checked = checked;
					});
				}
			});

			function deleteSelected() {
				function getSelectedTrashIds() {
					return Array.from(document.querySelectorAll('.trash-checkbox:checked'))
						.map(cb => cb.value);
				}
				const selectedIds = getSelectedTrashIds();

				if (!selectedIds.length) {
                    showPopup("Please select atleast one item.", 'yellow' , true, 2000, 'checkbox-status-alert');
					return;
				}

				fetch('/trash_delete/', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
						'X-CSRFToken': getCSRFToken()
					},
					body: JSON.stringify({ ids: selectedIds })
				}).then(res => {
					if (res.ok) {
						const modalEl = document.getElementById('trashModal');
						const modal = bootstrap.Modal.getInstance(modalEl);
						if (modal) {
							modal.hide();

							modalEl.addEventListener('hidden.bs.modal', function handler() {
								modalEl.removeEventListener('hidden.bs.modal', handler);
								showTrashPopup(); //Refresh modal contents after close
							});
						}
					}
				});
			}

			// Delete All Function

			function deleteAll() {
				// Get all trash item IDs (not just selected ones)
				function getAllTrashIds() {
					return Array.from(document.querySelectorAll('.trash-checkbox'))
						.map(cb => cb.value);
				}

				const allIds = getAllTrashIds();

				if (!allIds.length) {
                    showPopup("No items to delete.", 'red' ,true, 2000, 'no-items-in-trash');
					return;
				}

				// Confirmation dialog
				if (!confirm(`Are you sure you want to delete all ${allIds.length} items? This action cannot be undone.`)) {
					return;
				}

				fetch('/trash_delete/', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
						'X-CSRFToken': getCSRFToken()
					},
					body: JSON.stringify({ ids: allIds })
				}).then(res => {
					if (res.ok) {
						const modalEl = document.getElementById('trashModal');
						const modal = bootstrap.Modal.getInstance(modalEl);
						if (modal) {
							modal.hide();

							modalEl.addEventListener('hidden.bs.modal', function handler() {
								modalEl.removeEventListener('hidden.bs.modal', handler);
								showTrashPopup(); // Refresh modal contents after close
							});
						}
					} else {
						alert('Failed to delete items. Please try again.');
					}
				}).catch(error => {
					console.error('Error deleting items:', error);
					alert('An error occurred while deleting items.');
				});
			}


			function recoverSelected() {
				const selectedIds = Array.from(document.querySelectorAll('.trash-checkbox:checked'))
					.map(cb => cb.value);

				if (!selectedIds.length) {
                    showPopup("Please select atleast one item.", 'yellow' , true, 2000, 'checkbox-status-alert');
					return;
				}

				fetch('/trash_recover/', {
					method: 'POST',
					headers: {
						'Content-Type': 'application/json',
						'X-CSRFToken': getCSRFToken()
					},
					body: JSON.stringify({ ids: selectedIds })
				}).then(res => {
					if (res.ok) {
						const modalEl = document.getElementById('trashModal');
						const modal = bootstrap.Modal.getInstance(modalEl);
						if (modal) {
							modal.hide();

							modalEl.addEventListener('hidden.bs.modal', function handler() {
								modalEl.removeEventListener('hidden.bs.modal', handler);
								location.reload();  //Reload the page to see recovered items
							});
						}
					}
				});
			}

			function getCSRFToken() {
				return document.querySelector('[name=csrfmiddlewaretoken]').value;
			}

		</script>
		<script>
			function openEditModal(urlId) {
				fetch(`/get_url_details/${urlId}/`)
					.then(response => response.json())
					.then(data => {
						// Update modal fields
						document.getElementById('addUrlModalLabel').textContent = 'Edit URL';
						document.getElementById('urlForm').action = `/edit_url_view/${urlId}/`;
						document.getElementById('url-id').value = data.id;
						document.getElementById('url-textarea').value = data.url;
						document.getElementById('name').value = data.name;
						document.getElementById('category').value = data.category;
						document.getElementById('sub-category').value = data.sub_category;
						document.getElementById('tags').value = data.tags;

						if (data.category === 'others') {
							document.getElementById('custom-category-group').style.display = 'block';
							document.getElementById('custom-category').value = data.custom_category || '';
						} else {
							document.getElementById('custom-category-group').style.display = 'none';
							document.getElementById('custom-category').value = '';
						}

						document.getElementById('submit-button').textContent = 'Update URL';

						// Show the modal
						var myModal = new bootstrap.Modal(document.getElementById('addUrlModal'));
						myModal.show();
					});
			}
		</script>
	</body>
</html>
